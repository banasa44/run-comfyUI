# ========= Single-stage build (avoids disk space issues on GitHub Actions) =========
FROM nvidia/cuda:12.8.0-runtime-ubuntu22.04
SHELL ["/bin/bash", "-o", "pipefail", "-c"]

ENV DEBIAN_FRONTEND=noninteractive \
    TZ=Etc/UTC \
    COMFYUI_BRANCH=v0.3.66 \
    COMFYUI_AUTO_UPDATE=false \
    PYTHONUNBUFFERED=1

# Install system packages including Python 3.11
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3.11 python3.11-venv python3.11-dev python-is-python3 python3-pip \
    git git-lfs curl ca-certificates ffmpeg \
    libgl1 libglib2.0-0 libsqlite3-0 \
    build-essential gcc g++ make \
    iproute2 rsync \
  && rm -rf /var/lib/apt/lists/*

ENV CC=/usr/bin/gcc CXX=/usr/bin/g++

# Initialize git-lfs
RUN git lfs install

# Install uv for ComfyUI Manager compatibility
RUN curl -LsSf https://astral.sh/uv/install.sh | sh && \
    ln -sf /root/.local/bin/uv /usr/local/bin/uv || true

# Create and activate virtual environment
ENV VENV_PATH=/opt/venv
RUN python3.11 -m venv ${VENV_PATH}
ENV PATH="${VENV_PATH}/bin:${PATH}"

# Upgrade pip/wheel
RUN python -m pip install --no-cache-dir --upgrade pip setuptools wheel

# Install PyTorch with ARG for flexible CUDA version
# Default: cu128, can override with --build-arg TORCH_INDEX_URL=...
ARG TORCH_INDEX_URL=https://download.pytorch.org/whl/cu128
RUN python -m pip install --no-cache-dir \
    --index-url ${TORCH_INDEX_URL} \
    torch torchvision torchaudio

# Install essential packages + JupyterLab
RUN python -m pip install --no-cache-dir \
    requests numpy pillow opencv-python-headless jupyterlab tqdm \
    safetensors aiohttp onnx imageio-ffmpeg

# Clone ComfyUI and install ALL official requirements (prevent missing deps)
ARG COMFYUI_COMMIT=560b1bdfca77d9441ca2924fd9d6baa8dda05cd7
RUN git clone https://github.com/comfyanonymous/ComfyUI.git /tmp/comfyui && \
    cd /tmp/comfyui && \
    git checkout ${COMFYUI_COMMIT} && \
    python -m pip install --no-cache-dir -r requirements.txt && \
    rm -rf /tmp/comfyui

# --- Optional SageAttention (enable via build-arg) ---
ARG ENABLE_SAGEATTENTION=false
RUN if [ "$ENABLE_SAGEATTENTION" = "true" ]; then \
      python -m pip install --no-cache-dir "sageattention==1.0.6" || true ; \
    fi

# Create cache and log directories
RUN mkdir -p /workspace/.cache/huggingface \
             /workspace/.cache/pip \
             /workspace/.cache/torch \
             /workspace/logs

# Copy entrypoint script
COPY --chmod=755 comfy-entrypoint.sh /usr/local/bin/comfy-entrypoint.sh

EXPOSE 8188 8888
WORKDIR /workspace
CMD ["/usr/local/bin/comfy-entrypoint.sh"]
