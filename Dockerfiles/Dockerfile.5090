# ========= Use devel image for FlashAttention compilation =========
FROM nvidia/cuda:12.8.0-devel-ubuntu22.04
SHELL ["/bin/bash", "-o", "pipefail", "-c"]

ENV DEBIAN_FRONTEND=noninteractive \
    TZ=Etc/UTC \
    COMFYUI_BRANCH=v0.3.66 \
    COMFYUI_AUTO_UPDATE=false \
    PYTHONUNBUFFERED=1

# Install system packages including Python
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 python3-pip python3-venv python3-dev python-is-python3 \
    git git-lfs curl ca-certificates ffmpeg wget zip unzip vim \
    libgl1 libglib2.0-0 libsqlite3-0 \
    build-essential gcc g++ make pkg-config libcairo2-dev cmake ninja-build \
    iproute2 rsync ncdu \
  && rm -rf /var/lib/apt/lists/*

ENV CC=/usr/bin/gcc CXX=/usr/bin/g++

# Initialize git-lfs
RUN git lfs install

# Install uv for ComfyUI Manager compatibility
RUN curl -LsSf https://astral.sh/uv/install.sh | sh && \
    if [ -f "/root/.local/bin/uv" ]; then ln -sf /root/.local/bin/uv /usr/local/bin/uv; fi && \
    if [ -f "/root/.cargo/bin/uv" ]; then ln -sf /root/.cargo/bin/uv /usr/local/bin/uv; fi && \
    uv --version || true

# Define venv path first, then create it and update PATH
ENV VENV_PATH=/opt/venv
RUN python3 -m venv ${VENV_PATH}
ENV PATH="${VENV_PATH}/bin:/usr/local/cuda/bin:${PATH}"

# Upgrade pip/wheel
RUN python -m pip install --no-cache-dir --upgrade pip setuptools wheel

# Install PyTorch 2.9.1 for RTX 5090 with CUDA 12.8 (pinned exact wheels)
# Note: torchvision 0.24.1 is the compatible version for PyTorch 2.9.1
RUN python -m pip install --no-cache-dir \
    --index-url https://download.pytorch.org/whl/cu128 \
    torch==2.9.1+cu128 torchvision==0.24.1+cu128 torchaudio==2.9.1+cu128

# Verify PyTorch installation and CUDA version
RUN python -c "import torch; print(f'PyTorch: {torch.__version__}'); print(f'CUDA: {torch.version.cuda}')"

# Install essential packages + JupyterLab + ONNX Runtime GPU
RUN python -m pip install --no-cache-dir \
    requests numpy pillow opencv-python-headless jupyterlab tqdm \
    safetensors aiohttp onnx onnxruntime-gpu imageio-ffmpeg

# Upgrade albumentations to avoid runtime warnings
RUN python -m pip install --no-cache-dir -U albumentations

# Clone ComfyUI and install ALL official requirements (keep it!)
ARG COMFYUI_COMMIT=560b1bdfca77d9441ca2924fd9d6baa8dda05cd7
RUN git clone https://github.com/comfyanonymous/ComfyUI.git /ComfyUI && \
    cd /ComfyUI && \
    git checkout ${COMFYUI_COMMIT} && \
    python -m pip install --no-cache-dir -r requirements.txt && \
    mkdir -p /ComfyUI/pysssss-workflows

# Install performance optimizations for RTX 5090
# Triton 3.5.1 for optimal performance
RUN python -m pip install --no-cache-dir triton==3.5.1

# SageAttention 2.2.0 for optimized attention
RUN python -m pip install --no-cache-dir sageattention==2.2.0 || true

# FlashAttention 3.0 beta (requires compilation with python3-dev/cmake/ninja)
RUN python -m pip install --no-cache-dir \
    flash-attn==3.0.0b1 --no-build-isolation || \
    echo "FlashAttention install failed, skipping (optional optimization)"

# Clear PyTorch/Inductor caches to reduce image size
RUN rm -rf /root/.cache/torch /root/.triton /opt/venv/lib/python3.10/site-packages/torch/bin/.ninja_log

# Pre-install only essential custom nodes (rest can be installed via ComfyUI-Manager)
RUN set -eux; cd /ComfyUI/custom_nodes; \
    git clone https://github.com/ltdrdata/ComfyUI-Manager.git; \
    git clone https://github.com/kijai/ComfyUI-WanVideoWrapper.git; \
    pip install --no-cache-dir -r ComfyUI-WanVideoWrapper/requirements.txt

# Prune git histories to reduce image size
RUN find /ComfyUI -name .git -type d -prune -exec rm -rf {} +

# Create cache and log directories
RUN mkdir -p /workspace/.cache/huggingface \
             /workspace/.cache/pip \
             /workspace/.cache/torch \
             /workspace/logs

# Configure bash as default shell for better terminal experience
ENV SHELL=/bin/bash
RUN echo 'export PS1="\[\e[32m\]\u@\h\[\e[0m\]:\[\e[34m\]\w\[\e[0m\]\$ "' >> /root/.bashrc && \
    echo 'alias ll="ls -lah"' >> /root/.bashrc && \
    echo 'alias python=python3' >> /root/.bashrc

# Copy entrypoint script
COPY --chmod=755 comfy-entrypoint.sh /usr/local/bin/comfy-entrypoint.sh

EXPOSE 8188 8888
WORKDIR /workspace
CMD ["/usr/local/bin/comfy-entrypoint.sh"]
